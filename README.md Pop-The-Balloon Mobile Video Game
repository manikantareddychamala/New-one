import 'dart:async';
import 'dart:math';

import 'package:flutter/material.dart';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Balloon Popper',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: BalloonGame(),
    );
  }
}

class BalloonGame extends StatefulWidget {
  @override
  _BalloonGameState createState() => _BalloonGameState();
}

class _BalloonGameState extends State<BalloonGame> {
  int poppedBalloons = 0;
  int missedBalloons = 0;
  Timer timer;
  Duration duration = Duration(minutes: 2);
  Random random = Random();
  List<Widget> balloons = [];

  @override
  void initState() {
    super.initState();
    startTimer();
    startBalloonGeneration();
  }

  @override
  void dispose() {
    timer.cancel();
    super.dispose();
  }

  void startTimer() {
    timer = Timer.periodic(Duration(seconds: 1), (Timer t) {
      setState(() {
        if (duration.inSeconds == 0) {
          t.cancel();
          showEndScreen();
        } else {
          duration -= Duration(seconds: 1);
        }
      });
    });
  }

  void startBalloonGeneration() {
    Timer.periodic(Duration(milliseconds: 1500), (timer) {
      setState(() {
        balloons.add(Positioned(
          left: random.nextDouble() * 300,
          bottom: 0,
          child: GestureDetector(
            onTap: () {
              setState(() {
                poppedBalloons++;
                balloons.removeAt(0);
              });
            },
            child: Container(
              width: 50,
              height: 100,
              decoration: BoxDecoration(
                color: Colors.red,
                shape: BoxShape.circle,
              ),
            ),
          ),
        ));
      });
    });
  }

  void showEndScreen() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: Text("Game Over"),
          content: Text("Balloons Popped: $poppedBalloons"),
          actions: <Widget>[
            FlatButton(
              child: Text("Play Again"),
              onPressed: () {
                setState(() {
                  poppedBalloons = 0;
                  missedBalloons = 0;
                  duration = Duration(minutes: 2);
                  balloons.clear();
                  startTimer();
                  startBalloonGeneration();
                });
                Navigator.of(context).pop();
              },
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Balloon Popper'),
      ),
      body: Stack(
        children: [
          Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                '${duration.inMinutes.toString().padLeft(2, '0')}:${(duration.inSeconds % 60).toString().padLeft(2, '0')}',
                style: TextStyle(fontSize: 30),
              ),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  Column(
                    children: [
                      Text(
                        'Balloons Popped',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      Text(
                        poppedBalloons.toString(),
                        style: TextStyle(fontSize: 20),
                      ),
                    ],
                  ),
                  Column(
                    children: [
                       Text(
                        'Balloons Missed',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      Text(
                        missedBalloons.toString(),
                        style: TextStyle(fontSize: 20),
                      ),
                    ],
                  ),
                ],
              ),
            ],
          ),
          Stack(
            children: balloons,
          ),
        ],
      ),
    );
  }
}
